<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Unpackager</title>
    <style>
      :root {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          color: #eee;
          background-color: #111;
          color-scheme: dark;
        }
        a {
          color: #4af;
        }
      }

      main {
        max-width: 480px;
        margin: auto;
      }
    </style>
  </head>

  <body>
    <main>
      <h1>Unpackager</h1>

      <p>Select a file generated by the TurboWarp Packager and it'll output the original file that was packaged.</p>
      <p>Note that script positions and comments may be lost as the packager removes these to save space.</p>

      <input type="file" class="file-input" accept=".zip" autocomplete="off">

      <p class="download-section"></p>
    </main>

    <script src="dependencies/jszip.min.js"></script>
    <script>
      (function() {
        'use strict';

        const fileInput = document.querySelector('.file-input');
        const downloadSection = document.querySelector('.download-section');

        const getContainingFolder = (name) => {
          const parts = name.split('/');
          parts.pop();
          return parts.join('/');
        };

        const unpackage = async (blob) => {
          const packagedZip = await JSZip.loadAsync(blob);

          // TODO: escape . in path for regex
          const findFileInZip = (path) => packagedZip.file(path) || packagedZip.file(new RegExp(`^([^/]*/)?${path}$`))[0];

          const projectJSON = findFileInZip('project.json');
          if (projectJSON) {
            const innerFolderPath = getContainingFolder(projectJSON.name);
            const innerZip = packagedZip.folder(innerFolderPath);

            return {
              type: 'sb3',
              data: await innerZip.generateAsync({
                type: 'arraybuffer',
                compression: 'DEFLATE'
              })
            };
          }

          // const projectBinary = findFileInZip('project.zip');
        };

        fileInput.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (!file) {
            return;
          }

          while (downloadSection.firstChild) {
            downloadSection.firstChild.remove();
          }

          try {
            const unpackaged = await unpackage(file);
            const type = unpackaged.type;
            const data = unpackaged.data;
            const name = `${file.name}.${type}`;

            const blob = new Blob([data], {
              type: `application/x.scratch.${type}`
            });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = name;
            link.textContent = `Download ${name} (${(blob.size / 1000 / 1000).toFixed(2)}MB)`;
            downloadSection.appendChild(link);
            link.click();
          } catch (e) {
            console.error(e);
            alert(e);
          }
        });
      }());
    </script>
  </body>
</html>
